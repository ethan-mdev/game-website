---
// News component for the homepage
---

<section id="news" class="py-20 bg-neutral-800">
  <div class="container mx-auto px-4 lg:px-8">
    <div class="text-center mb-12">
      <h2 class="text-3xl lg:text-4xl font-bold text-white mb-4">
        Latest <span class="text-purple-400">News</span> & Updates
      </h2>
      <p class="text-lg text-gray-300 max-w-2xl mx-auto">
        Stay up to date with the latest patches, events, and announcements from
        the Game development team.
      </p>
    </div>

    <div class="max-w-7xl mx-auto">
      <!-- News Carousel Container -->
      <div class="relative">
        <!-- Main News Display -->
        <div
          id="news-carousel"
          class="grid grid-cols-1 lg:grid-cols-3 gap-8 transition-all duration-500"
        >
          <!-- Featured News Article (Left Side) -->
          <div class="lg:col-span-2">
            <article
              id="featured-article"
              class="rounded-2xl bg-gradient-to-br from-purple-500/10 via-slate-900/80 to-violet-500/10 ring-2 ring-purple-500/40 p-8 h-full"
            >
              <!-- populated by JS -->
              <div id="featured-skeleton" class="animate-pulse space-y-4">
                <div class="h-4 w-24 bg-neutral-700 rounded"></div>
                <div class="h-7 w-3/4 bg-neutral-700 rounded"></div>
                <div class="h-4 w-full bg-neutral-800 rounded"></div>
                <div class="h-4 w-5/6 bg-neutral-800 rounded"></div>
                <div class="h-8 w-40 bg-neutral-700 rounded"></div>
              </div>
            </article>
          </div>

          <!-- Recent News Sidebar (Right Side) -->
          <div class="space-y-6">
            <div class="flex items-center justify-between">
              <h4 class="text-xl font-bold text-white">All Updates</h4>
              <span id="news-counter" class="text-sm text-gray-400">—</span>
            </div>

            <!-- Scrollable News List -->
            <div
              id="news-sidebar"
              class="space-y-4 max-h-96 overflow-y-auto pr-2 scrollbar-thin scrollbar-track-neutral-800 scrollbar-thumb-purple-500/50"
            >
              <!-- populated by JS -->
              <div class="space-y-3">
                <div
                  class="h-16 bg-neutral-900/80 ring-1 ring-neutral-800 rounded-xl animate-pulse"
                >
                </div>
                <div
                  class="h-16 bg-neutral-900/80 ring-1 ring-neutral-800 rounded-xl animate-pulse"
                >
                </div>
                <div
                  class="h-16 bg-neutral-900/80 ring-1 ring-neutral-800 rounded-xl animate-pulse"
                >
                </div>
              </div>
            </div>

            <!-- Navigation Controls -->
            <div class="flex items-center justify-center gap-4 pt-4">
              <button
                id="news-prev"
                class="p-3 rounded-full bg-neutral-800 hover:bg-neutral-700 text-gray-400 hover:text-purple-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                title="Previous News"
                disabled
              >
                <svg
                  class="w-5 h-5 transform -rotate-90"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>

              <button
                id="news-next"
                class="p-3 rounded-full bg-neutral-800 hover:bg-neutral-700 text-gray-400 hover:text-purple-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                title="Next News"
                disabled
              >
                <svg
                  class="w-5 h-5 transform rotate-90"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"
                    clip-rule="evenodd"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- News carousel functionality -->
<script is:inline>
  document.addEventListener("DOMContentLoaded", async function () {
    // Elements
    const featuredArticle = document.getElementById("featured-article");
    const newsSidebar = document.getElementById("news-sidebar");
    const newsCounter = document.getElementById("news-counter");
    const prevBtn = document.getElementById("news-prev");
    const nextBtn = document.getElementById("news-next");

    // Helpers
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    let allNews = [];
    let currentIndex = 0;

    // 1) Fetch latest announcements from forum API
    try {
      const res = await fetch("/api/forum/news?limit=20", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch announcements");
      const data = await res.json();
      
      if (!data.ok || !data.news) {
        throw new Error("Invalid response from announcements API");
      }
      
      allNews = data.news;
    } catch (err) {
      console.error(err);
      // minimal fallback UI
      newsCounter.textContent = "0 of 0";
      featuredArticle.innerHTML =
        '<p class="text-sm text-gray-400">Unable to load announcements right now.</p>';
      return;
    }

    // 2) Rendering

    function updateFeaturedArticle() {
      const currentNews = allNews[currentIndex];
      if (!currentNews) return;

      // Tags are now objects with name, color, textColor
      const tagsHTML = (currentNews.tags || [])
        .map((tag) => {
          return `<span class="${tag.color} ${tag.textColor} text-sm px-3 py-1 rounded-full border ${tag.color.replace('/20', '/50').replace('bg-', 'border-')}">${tag.name}</span>`;
        })
        .join("");

      // Add stats display
      const statsHTML = currentNews.stats ? `
        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span>✍️ by ${currentNews.author}</span>
        </div>
      ` : '';

      featuredArticle.innerHTML = `
        <div class="flex items-center gap-2 mb-4">
          <span class="bg-purple-500 text-white text-sm font-bold px-3 py-1 rounded-full">FEATURED</span>
          <span class="text-sm text-gray-400">${formatDate(currentNews.date)}</span>
        </div>

        <h3 class="text-2xl font-bold text-purple-400 mb-4">${currentNews.title}</h3>

        <p class="text-gray-300 mb-6 leading-relaxed">${currentNews.excerpt || ""}</p>

        <div class="flex flex-wrap gap-2 mb-6">${tagsHTML}</div>

        ${statsHTML}

        <div class="flex items-center justify-between mt-6">
          <a
            href="/forum/thread/${currentNews.threadId}"
            class="bg-purple-500 hover:bg-purple-400 text-white font-semibold px-6 py-3 rounded-lg transition-colors">
            Read Full Announcement →
          </a>
        </div>
      `;
    }

    function updateSidebar() {
      const sidebarHTML = allNews
        .map((article, index) => {
          const isActive = index === currentIndex;
          const firstTag = article.tags?.[0];
          return `
          <article class="rounded-xl bg-neutral-900/80 ring-1 ${isActive ? "ring-purple-500/60 bg-purple-500/5" : "ring-neutral-700"} p-4 hover:ring-purple-500/40 transition-all cursor-pointer news-item"
                   data-index="${index}">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs text-gray-400">${formatDate(article.date)}</span>
              ${firstTag ? `<span class="${firstTag.color} ${firstTag.textColor} text-xs px-2 py-1 rounded-full">${firstTag.name}</span>` : ""}
            </div>
            <h5 class="font-bold ${isActive ? "text-purple-300" : "text-gray-200"} mb-2 text-sm">${article.title}</h5>
            <p class="text-xs text-gray-400 line-clamp-2">${article.excerpt || ""}</p>
          </article>
        `;
        })
        .join("");
      newsSidebar.innerHTML = sidebarHTML;

      // Click handlers
      document.querySelectorAll(".news-item").forEach((item) => {
        item.addEventListener("click", () => {
          const index = parseInt(item.getAttribute("data-index"));
          if (!Number.isNaN(index)) {
            currentIndex = index;
            updateDisplay();
          }
        });
      });
    }

    function updateCounter() {
      newsCounter.textContent = `${currentIndex + 1} of ${allNews.length}`;
    }

    function updateNavButtons() {
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === allNews.length - 1;
    }

    function updateDisplay() {
      updateFeaturedArticle();
      updateSidebar();
      updateCounter();
      updateNavButtons();
    }

    // 3) Navigation events
    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateDisplay();
      }
    });
    nextBtn.addEventListener("click", () => {
      if (currentIndex < allNews.length - 1) {
        currentIndex++;
        updateDisplay();
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft" && currentIndex > 0) {
        currentIndex--;
        updateDisplay();
      }
      if (e.key === "ArrowRight" && currentIndex < allNews.length - 1) {
        currentIndex++;
        updateDisplay();
      }
    });

    // 4) Initial render
    updateDisplay();
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .scrollbar-thin {
    scrollbar-width: thin;
  }
  .scrollbar-track-neutral-800::-webkit-scrollbar-track {
    background: rgb(38 38 38);
  }
  .scrollbar-thumb-purple-500\/50::-webkit-scrollbar-thumb {
    background: rgba(168 85 247 / 0.5);
    border-radius: 4px;
  }
  .scrollbar-thumb-purple-500\/50::-webkit-scrollbar-thumb:hover {
    background: rgba(168 85 247 / 0.7);
  }
  ::-webkit-scrollbar {
    width: 6px;
  }
</style>
